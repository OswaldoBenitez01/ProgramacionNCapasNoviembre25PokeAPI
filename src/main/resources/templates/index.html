<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
    <head>
        <title>Pokédex</title>
        <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <style>
            * { box-sizing: border-box; margin: 0; padding: 0; }

            body {
                font-family: 'Press Start 2P', monospace;
                background-color: #1b1b2f;
                background-image:
                    linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
                    linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
                background-size: 40px 40px;
                min-height: 100vh;
                padding: 90px 20px 30px;
                color: #fff;
            }

            .navbar-retro {
                position: fixed; top: 0; left: 0; width: 100%;
                display: flex; justify-content: space-between; align-items: center;
                padding: 15px 25px;
                background: rgba(0,0,0,0.85);
                backdrop-filter: blur(5px);
                border-bottom: 3px solid #333;
                z-index: 2000;
            }
            .logout-btn {
                background: rgba(0,0,0,0.8); border: 2px solid #dc3545; color: #dc3545;
                padding: 10px 16px; font-size: 0.7rem; border-radius: 8px;
                cursor: pointer; font-family: 'Press Start 2P', monospace;
                box-shadow: 0 0 10px rgba(220,53,69,0.3); transition: 0.3s;
            }
            .logout-btn:hover { background: #dc3545; color: #fff; }
            .nav-custom-btn {
                display: flex; align-items: center; gap: 8px;
                padding: 10px 16px; font-size: 0.65rem; border-radius: 8px;
                text-decoration: none; border: 2px solid #ff0;
                font-family: 'Press Start 2P', monospace; transition: all 0.3s ease;
            }
            .fav-btn-style { background: rgba(0,0,0,0.8); color: #ff0; box-shadow: 0 0 10px rgba(255,255,0,0.3); }
            .fav-btn-style:hover { background: #ff0; color: #000; box-shadow: 0 0 20px #ff0; }

            .header { text-align: center; margin-bottom: 20px; }
            .header h1 {
                font-size: clamp(1.2rem, 4vw, 2rem); color: #fff;
                text-shadow: 0 0 10px #ff0, 0 0 20px #ff0, 0 0 40px #f80;
                letter-spacing: 4px; cursor: pointer; transition: all 0.2s ease;
            }
            .header h1:hover { text-shadow: 0 0 20px #ff0, 0 0 40px #ff0, 0 0 60px #f80; }

            .filters-bar {
                max-width: 1400px; margin: 0 auto 28px;
                display: flex; align-items: center; gap: 14px; flex-wrap: wrap;
            }
            .filters-bar label { font-size: 0.5rem; color: #aaa; white-space: nowrap; }
            .filters-bar select {
                background: #0d0d1a; border: 2px solid rgba(255,255,255,0.15);
                color: #fff; padding: 6px 10px;
                font-family: 'Press Start 2P', monospace; font-size: 0.55rem;
                border-radius: 8px; height: 36px; transition: border-color 0.2s;
            }
            .filters-bar select:focus { border-color: #ff0; outline: none; }
            .filters-bar select option { background: #1b1b2f; }
            .filter-bar-btn {
                height: 36px; padding: 0 14px;
                font-family: 'Press Start 2P', monospace; font-size: 0.5rem;
                border-radius: 8px; cursor: pointer; border: 2px solid;
                transition: all 0.2s; white-space: nowrap; background: transparent;
            }
            .filter-bar-btn:hover { transform: translateY(-1px); }
            .filter-bar-btn.apply { border-color: #28a745; color: #28a745; }
            .filter-bar-btn.apply:hover { background: #28a745; color: #fff; }
            .filter-bar-btn.clear  { border-color: #dc3545; color: #dc3545; }
            .filter-bar-btn.clear:hover { background: #dc3545; color: #fff; }

            .filter-chips {
                max-width: 1400px; margin: 0 auto 20px;
                display: flex; gap: 12px; flex-wrap: wrap;
            }
            .chip {
                background: linear-gradient(145deg, rgba(255,255,0,0.2), rgba(255,165,0,0.1));
                border: 2px solid #ff0; padding: 8px 14px; border-radius: 25px;
                font-size: 0.6rem; cursor: pointer;
                display: flex; align-items: center; gap: 6px;
                transition: all 0.3s; text-decoration: none; color: #fff;
            }
            .chip:hover { background: linear-gradient(145deg, #ff0, #ff8c00); color: #000; }
            .chip.clear { background: rgba(220,53,69,0.2); border-color: #dc3545; color: #dc3545; }
            .chip.clear:hover { background: #dc3545; color: #fff; }

            .grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
                gap: 30px; max-width: 1400px; margin: 0 auto 40px;
            }
            .card-container { height: 300px; perspective: 1000px; }
            .card-inner {
                position: relative; width: 100%; height: 100%;
                transform-style: preserve-3d; transition: transform 0.7s ease;
            }
            .card-container:hover .card-inner { transform: rotateY(180deg); }
            .card-face {
                position: absolute; width: 100%; height: 100%;
                backface-visibility: hidden; border-radius: 12px; padding: 16px;
                display: flex; flex-direction: column;
            }

            .card-front {
                border: 3px solid rgba(255,255,255,0.15);
                box-shadow: 0 0 10px rgba(255,255,255,0.05), inset 0 0 20px rgba(0,0,0,0.3);
            }
            .card-front .poke-header {
                display: flex; justify-content: space-between;
                align-items: flex-start; margin-bottom: 8px;
            }
            .card-front .poke-name {
                font-size: 0.7rem; text-transform: uppercase;
                text-shadow: 1px 1px 0 rgba(0,0,0,0.8);
                max-width: 120px; word-break: break-word; line-height: 1.5;
            }
            .card-front .poke-id {
                font-size: 0.55rem; background: rgba(0,0,0,0.5);
                padding: 4px 6px; border-radius: 6px; white-space: nowrap;
            }
            .card-front .poke-sprite {
                flex: 1; display: flex; align-items: center; justify-content: center;
            }
            .card-front .poke-sprite img {
                width: 80%; height: 80%; image-rendering: pixelated;
                filter: drop-shadow(3px 3px 0px rgba(0,0,0,0.7));
            }
            .card-front .poke-types {
                display: flex; gap: 6px; flex-wrap: wrap; justify-content: center;
            }
            .type-badge {
                font-size: 0.5rem; padding: 4px 8px; border-radius: 6px;
                text-transform: uppercase; background: rgba(0,0,0,0.4);
                border: 1px solid rgba(255,255,255,0.3);
            }

            .poke-stats {
                display: flex; align-items: center;
                justify-content: flex-end; gap: 5px; margin-top: 6px;
            }
            .poke-stats .heart-svg {
                width: 16px; height: 16px;
                image-rendering: pixelated;
                filter: brightness(0) invert(1);
            }
            .poke-stats .count-badge {
                font-size: 0.45rem; color: #fff;
                background: rgba(0,0,0,0.45);
                padding: 2px 5px; border-radius: 4px;
            }

            .card-back {
                transform: rotateY(180deg);
                background: #12122a;
                border: 3px solid rgba(255,255,255,0.1);
                display: flex; flex-direction: column;
                justify-content: space-between;
                align-items: center; padding: 12px;
            }
            .back-title {
                font-size: 0.55rem; color: #aaa; text-align: center;
                letter-spacing: 2px; text-transform: uppercase; width: 100%;
            }
            .stats-radar {
                flex: 1; display: flex; flex-direction: column;
                align-items: center; justify-content: center; gap: 4px;
            }

            .detail-btn {
                display: block; width: 100%; text-align: center;
                padding: 8px 0; background: transparent;
                border: 2px solid #ff0; color: #ff0;
                font-family: 'Press Start 2P', monospace; font-size: 0.5rem;
                border-radius: 8px; text-decoration: none; letter-spacing: 1px;
                text-shadow: 0 0 6px #ff0; box-shadow: 0 0 8px rgba(255,255,0,0.3);
                transition: all 0.2s ease;
            }
            .detail-btn:hover { transform: translateY(-1px); }
            .btn-favorito:hover:not(:disabled) { transform: translateY(-2px); }


            .btn-favorito {
                width: 100%; margin-top: 10px; padding: 10px;
                font-family: 'Press Start 2P', monospace; font-size: 0.5rem;
                cursor: pointer; border-radius: 8px; transition: all 0.3s ease;
                display: flex; align-items: center; justify-content: center; gap: 8px;
                text-transform: uppercase; border: 2px solid #ff0;
                background: rgba(255,255,0,0.05); color: #ff0;
                box-shadow: 0 0 10px rgba(255,255,0,0.2);
            }
            .btn-favorito:hover:not(:disabled) { filter: brightness(1.2); transform: translateY(-2px); }
            .btn-favorito:disabled {
                border-color: #00f7ff; color: #00f7ff;
                background: rgba(0,247,255,0.1);
                box-shadow: 0 0 15px rgba(0,247,255,0.4);
                cursor: not-allowed; opacity: 1;
            }
            @keyframes star-pulse { from { transform: scale(1); } to { transform: scale(1.3); } }
            .btn-favorito:hover i { animation: star-pulse 0.5s infinite alternate; }

            .pagination-wrapper {
                display: flex; justify-content: center; align-items: center;
                flex-wrap: wrap; gap: 14px; margin-top: 40px;
            }
            .page-btn {
                font-family: 'Press Start 2P', monospace; font-size: 0.6rem;
                padding: 10px 16px; background: transparent;
                border: 2px solid #fff; color: #fff; border-radius: 8px;
                text-decoration: none; letter-spacing: 1px; transition: all 0.2s ease;
            }
            .page-btn:hover { background: #fff; color: #000; box-shadow: 0 0 12px rgba(255,255,255,0.5); }
            .page-info {
                font-size: 0.6rem; color: #aaa; padding: 10px 16px;
                border: 2px solid #333; border-radius: 8px;
            }
            .page-jump { display: flex; align-items: center; gap: 8px; }
            .page-jump label { font-size: 0.5rem; color: #aaa; }
            .page-jump input {
                width: 70px; height: 38px; background: #0d0d1a;
                border: 2px solid #444; border-radius: 8px; color: #fff;
                font-family: 'Press Start 2P', monospace; font-size: 0.6rem;
                text-align: center; outline: none;
            }
            .page-jump input:focus { border-color: #ff0; box-shadow: 0 0 8px rgba(255,255,0,0.4); }
            .page-jump input.input-error { border-color: #f66; }
            .page-jump input:disabled,
            .page-jump button:disabled { opacity: 0.35; cursor: not-allowed; pointer-events: none; }
            .page-jump button {
                height: 38px; padding: 0 12px; background: transparent;
                border: 2px solid #ff0; color: #ff0;
                font-family: 'Press Start 2P', monospace; font-size: 0.5rem;
                border-radius: 8px; cursor: pointer; transition: all 0.2s ease;
            }
            .page-jump button:not(:disabled):hover { background: #ff0; color: #000; }
            .error-msg { font-size: 0.45rem; color: #f66; display: none; }

            @media (max-width: 600px) {
                .grid { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); }
                .card-container { height: 260px; }
                .filters-bar { gap: 8px; }
            }
        </style>
    </head>
    <body>

        <nav class="navbar-retro">
            <div sec:authorize="hasRole('Administrador')">
                <a th:href="@{/usuarios/admin}" class="nav-custom-btn fav-btn-style"
                   style="border-color:#e63946; color:#e63946; box-shadow:0 0 10px rgba(230,57,70,0.3);">
                    &#x2699; ADMIN PANEL
                </a>
            </div>
            <div sec:authorize="hasRole('Usuario')">
                <a th:href="@{/pokemon/favoritos}" class="nav-custom-btn fav-btn-style">
                    &#x2665; FAVORITOS
                </a>
            </div>
            <span style="font-size:0.5rem; color:#aaa; letter-spacing:2px;"
                  sec:authentication="name"></span>
            <form th:action="@{/logout}" method="post" style="margin:0;">
                <button type="submit" class="logout-btn">&#x23FB; SALIR</button>
            </form>
        </nav>

        <div class="header">
            <h1 onclick="window.location.href='/pokemon'">&#x25B6; POKÉDEX</h1>
        </div>

        <div class="filters-bar">
            <form th:action="@{/pokemon}" method="get"
                  style="display:flex; align-items:center; gap:14px; flex-wrap:wrap; width:100%;">
                <input type="hidden" name="limit"  th:value="${limit}"/>
                <input type="hidden" name="offset" value="0"/>

                <label>TIPO</label>
                <select name="type">
                    <option value="">— Todos —</option>
                    <option th:each="tipo : ${tipos}"
                            th:value="${tipo.name}"
                            th:selected="${tipo.name == currentType}"
                            th:text="${tipo.name}"></option>
                </select>

                <label>REGIÓN</label>
                <select name="region">
                    <option value="">— Todas —</option>
                    <option value="kanto"  th:selected="${'kanto'  == currentRegion}">Kanto  (Gen 1)</option>
                    <option value="johto"  th:selected="${'johto'  == currentRegion}">Johto  (Gen 2)</option>
                    <option value="hoenn"  th:selected="${'hoenn'  == currentRegion}">Hoenn  (Gen 3)</option>
                    <option value="sinnoh" th:selected="${'sinnoh' == currentRegion}">Sinnoh (Gen 4)</option>
                    <option value="unova"  th:selected="${'unova'  == currentRegion}">Unova  (Gen 5)</option>
                    <option value="kalos"  th:selected="${'kalos'  == currentRegion}">Kalos  (Gen 6)</option>
                    <option value="alola"  th:selected="${'alola'  == currentRegion}">Alola  (Gen 7)</option>
                    <option value="galar"  th:selected="${'galar'  == currentRegion}">Galar  (Gen 8)</option>
                </select>

                <button type="submit" class="filter-bar-btn apply">APLICAR</button>
                <button type="button" class="filter-bar-btn clear"
                        onclick="window.location.href='/pokemon?limit=20&amp;offset=0'">LIMPIAR</button>
            </form>
        </div>

        <div class="filter-chips"
             th:if="${(currentType != null and !#strings.isEmpty(currentType)) or
                      (currentRegion != null and !#strings.isEmpty(currentRegion))}">
            <span class="chip"
                  th:if="${currentType != null and !#strings.isEmpty(currentType)}"
                  onclick="removeFilter('type')">
                Tipo: <span th:text="${currentType}"></span> ✕
            </span>
            <span class="chip"
                  th:if="${currentRegion != null and !#strings.isEmpty(currentRegion)}"
                  onclick="removeFilter('region')">
                Región: <span th:text="${currentRegion}"></span> ✕
            </span>
        </div>

        <div th:if="${result.Correct == false}"
             style="text-align:center; color:#f66; font-size:0.7rem; max-width:800px; margin:0 auto 40px;">
            <p th:text="${result.ErrorMessage}"></p>
        </div>

        <div class="grid" th:if="${result.Correct == true}">
            <div class="card-container" th:each="pokemon : ${result.Objects}">
                <div class="card-inner">

                    <div class="card-face card-front"
                         th:style="'background: ' + ${@pokeApiController.obtenerTipo(pokemon)}">
                        <div class="poke-header">
                            <div class="poke-name" th:text="${pokemon.name}"></div>
                            <div class="poke-id"   th:text="'#' + ${#numbers.formatInteger(pokemon.id, 3)}"></div>
                        </div>
                        <div class="poke-sprite">
                            <img th:if="${pokemon.sprites != null}"
                                 th:src="${pokemon.sprites.frontDefault}"
                                 th:alt="${pokemon.name}">
                        </div>
                        <div class="poke-types">
                            <span class="type-badge"
                                  th:each="t : ${pokemon.types}"
                                  th:text="${t.type.name}"></span>
                        </div>
                        <div class="poke-stats" sec:authorize="hasRole('Administrador')">
                            <svg class="heart-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                                 width="16" height="16" fill="white">
                                <polygon points="23 6 23 11 22 11 22 12 21 12 21 13 20 13 20 14 19 14 19 15 18 15 18 16 17 16 17 17 16 17 16 18 15 18 15 19 14 19 14 20 13 20 13 21 11 21 11 20 10 20 10 19 9 19 9 18 8 18 8 17 7 17 7 16 6 16 6 15 5 15 5 14 4 14 4 13 3 13 3 12 2 12 2 11 1 11 1 6 2 6 2 5 3 5 3 4 4 4 4 3 10 3 10 4 11 4 11 5 13 5 13 4 14 4 14 3 20 3 20 4 21 4 21 5 22 5 22 6 23 6"/>
                            </svg>
                            <span class="count-badge" th:text="${conteos[pokemon.id.toString()] ?: 0}"></span>
                        </div>
                    </div>

                    <div class="card-face card-back">
                        <div class="back-title" th:text="${pokemon.name}"></div>

                        <div class="stats-radar" th:if="${pokemon.stats != null}">
                            <canvas class="radar-canvas" width="200" height="200"
                                    th:attr="data-stats=${pokemon.stats[0].baseStat + ',' +
                                             pokemon.stats[1].baseStat + ',' +
                                             pokemon.stats[2].baseStat + ',' +
                                             pokemon.stats[3].baseStat + ',' +
                                             pokemon.stats[4].baseStat + ',' +
                                             pokemon.stats[5].baseStat},
                                             data-tipo=${pokemon.types[0].type.name}">
                            </canvas>
                        </div>

                        <input type="hidden" id="idUsuarioLogueado" th:value="${UsuarioL.idUsuario}"/>

                        <button sec:authorize="hasRole('Usuario')"
                                type="button" class="btn-favorito"
                                th:data-id="${pokemon.id}"
                                th:data-tipo="${pokemon.types[0].type.name}"
                                th:disabled="${Favoritos.contains(pokemon.id.toString())}"
                                onclick="agregarFavorito(this)">
                            <i th:class="${Favoritos.contains(pokemon.id.toString()) ? 'bi bi-star-fill' : 'bi bi-star'}"></i>
                            <span th:text="${Favoritos.contains(pokemon.id.toString()) ? 'EN EQUIPO' : 'CAPTURAR'}"></span>
                        </button>

                        <a class="detail-btn" th:href="@{/pokemon/{name}(name=${pokemon.name})}">
                            VER DETALLE
                        </a>
                    </div>

                </div>
            </div>
        </div>

        <div class="pagination-wrapper" th:if="${result.Correct == true}">
            <a class="page-btn"
               th:if="${currentOffset > 0}"
               th:href="@{/pokemon(limit=${limit}, offset=${currentOffset - limit}, type=${currentType}, region=${currentRegion})}">
                ← ANTERIOR
            </a>
            <span class="page-info">
                PÁG. <span th:text="${(currentOffset / limit) + 1}"></span>
            </span>
            <a class="page-btn"
               th:if="${#lists.size(result.Objects) >= limit}"
               th:href="@{/pokemon(limit=${limit}, offset=${currentOffset + limit}, type=${currentType}, region=${currentRegion})}">
                SIGUIENTE →
            </a>
            <form class="page-jump" id="jumpForm" th:action="@{/pokemon}" method="get">
                <input type="hidden" name="limit"  th:value="${limit}"/>
                <input type="hidden" name="type"   th:value="${currentType}"/>
                <input type="hidden" name="region" th:value="${currentRegion}"/>
                <label>IR A</label>
                <input type="text" id="pageInput" name="page" placeholder="Pág." maxlength="4"
                       th:value="${(currentOffset / limit) + 1}"
                       th:disabled="${#lists.size(result.Objects) < limit}"/>
                <span class="error-msg" id="pageError">Solo números</span>
                <button type="submit"
                        th:disabled="${#lists.size(result.Objects) < limit}">OK</button>
            </form>
        </div>

        <script>
            var TIPO_COLOR = {
                fire:'#f08030', water:'#6890f0', grass:'#78c850', electric:'#f8d030',
                normal:'#a8a878', fighting:'#c03028', poison:'#a040a0', ground:'#e0c068',
                flying:'#a890f0', psychic:'#f85888', bug:'#a8b820', rock:'#b8a038',
                ghost:'#705898', dragon:'#7038f8', steel:'#b8b8d0', fairy:'#ee99ac',
                dark:'#705848', ice:'#98d8d8'
            };

            function hexToRgba(hex, alpha) {
                var r = parseInt(hex.slice(1,3), 16);
                var g = parseInt(hex.slice(3,5), 16);
                var b = parseInt(hex.slice(5,7), 16);
                return 'rgba(' + r + ',' + g + ',' + b + ',' + alpha + ')';
            }

            document.addEventListener('DOMContentLoaded', function() {

                document.querySelectorAll('.card-back').forEach(function(back) {
                    var btnFav = back.querySelector('.btn-favorito');
                    var canvas = back.querySelector('.radar-canvas');
                    var tipo   = (btnFav && btnFav.getAttribute('data-tipo'))
                                    ? btnFav.getAttribute('data-tipo')
                                    : (canvas ? canvas.getAttribute('data-tipo') : '');
                    var color  = TIPO_COLOR[tipo] || '#ff0';

                    if (btnFav && !btnFav.disabled) {
                        btnFav.style.borderColor = color;
                        btnFav.style.color       = color;
                        btnFav.style.background  = hexToRgba(color, 0.08);
                        btnFav.style.boxShadow   = '0 0 10px ' + hexToRgba(color, 0.3);
                        btnFav.setAttribute('data-color', color);
                    }

                    var btnDetalle = back.querySelector('.detail-btn');
                    if (btnDetalle) {
                        btnDetalle.style.borderColor = color;
                        btnDetalle.style.color       = color;
                        btnDetalle.style.textShadow  = '0 0 6px ' + color;
                        btnDetalle.style.boxShadow   = '0 0 8px ' + hexToRgba(color, 0.3);
                        btnDetalle.setAttribute('data-color', color);
                    }
                });

                document.querySelectorAll('.detail-btn').forEach(function(btn) {
                    btn.addEventListener('mouseenter', function() {
                        var c = this.getAttribute('data-color') || '#ff0';
                        this.style.background  = c;
                        this.style.color       = '#000';
                        this.style.textShadow  = 'none';
                        this.style.boxShadow   = '0 0 16px ' + hexToRgba(c, 0.7);
                    });
                    btn.addEventListener('mouseleave', function() {
                        var c = this.getAttribute('data-color') || '#ff0';
                        this.style.background  = 'transparent';
                        this.style.color       = c;
                        this.style.textShadow  = '0 0 6px ' + c;
                        this.style.boxShadow   = '0 0 8px ' + hexToRgba(c, 0.3);
                    });
                });

                document.querySelectorAll('.btn-favorito:not(:disabled)').forEach(function(btn) {
                    btn.addEventListener('mouseenter', function() {
                        var c = this.getAttribute('data-color') || '#ff0';
                        this.style.background  = c;
                        this.style.color       = '#000';
                        this.style.boxShadow   = '0 0 20px ' + c;
                    });
                    btn.addEventListener('mouseleave', function() {
                        var c = this.getAttribute('data-color') || '#ff0';
                        this.style.background  = hexToRgba(c, 0.08);
                        this.style.color       = c;
                        this.style.boxShadow   = '0 0 10px ' + hexToRgba(c, 0.3);
                    });
                });


                document.querySelectorAll('.radar-canvas').forEach(function(canvas) {
                    var raw   = canvas.getAttribute('data-stats');
                    var tipo  = canvas.getAttribute('data-tipo') || '';
                    var color = TIPO_COLOR[tipo] || '#ff0';
                    if (!raw) return;
                    var values = raw.split(',').map(function(v) { return parseInt(v.trim(), 10) || 0; });
                    drawRadar(canvas, values, color);
                });

                var pageInput = document.getElementById('pageInput');
                var pageError = document.getElementById('pageError');
                var jumpForm  = document.getElementById('jumpForm');

                if (pageInput && !pageInput.disabled) {
                    pageInput.addEventListener('keypress', function(e) { if (!/[0-9]/.test(e.key)) e.preventDefault(); });
                    pageInput.addEventListener('input',    function()  { this.value = this.value.replace(/[^0-9]/g, ''); });
                }

                if (jumpForm) {
                    jumpForm.addEventListener('submit', function(e) {
                        if (pageInput.disabled) { e.preventDefault(); return; }
                        var val = pageInput.value.trim();
                        if (!val || isNaN(val) || parseInt(val) < 1) {
                            e.preventDefault();
                            pageInput.classList.add('input-error');
                            pageError.style.display = 'block';
                            setTimeout(function() {
                                pageInput.classList.remove('input-error');
                                pageError.style.display = 'none';
                            }, 2000);
                            return;
                        }
                        var lim    = parseInt(jumpForm.querySelector('input[name="limit"]').value) || 12;
                        var offset = (parseInt(val) - 1) * lim;
                        var input  = document.createElement('input');
                        input.type  = 'hidden';
                        input.name  = 'offset';
                        input.value = offset.toString();
                        jumpForm.appendChild(input);
                    });
                }
            });

            function drawRadar(canvas, values, color) {
                var ctx    = canvas.getContext('2d');
                var labels = ['HP', 'ATK', 'DEF', 'SpA', 'SpD', 'SPD'];
                var n      = values.length;
                var cx     = canvas.width  / 2;
                var cy     = canvas.height / 2;
                var radius = Math.min(cx, cy) - 22;
                var maxVal = 150;

                ctx.clearRect(0, 0, canvas.width, canvas.height);

                for (var level = 1; level <= 4; level++) {
                    var r = radius * (level / 4);
                    ctx.beginPath();
                    ctx.strokeStyle = 'rgba(255,255,255,0.15)';
                    ctx.lineWidth = 1;
                    for (var i = 0; i < n; i++) {
                        var angle = (Math.PI * 2 / n) * i - Math.PI / 2;
                        i === 0
                            ? ctx.moveTo(cx + r * Math.cos(angle), cy + r * Math.sin(angle))
                            : ctx.lineTo(cx + r * Math.cos(angle), cy + r * Math.sin(angle));
                    }
                    ctx.closePath();
                    ctx.stroke();
                }

                ctx.strokeStyle = 'rgba(255,255,255,0.2)';
                for (var i = 0; i < n; i++) {
                    var angle = (Math.PI * 2 / n) * i - Math.PI / 2;
                    ctx.beginPath();
                    ctx.moveTo(cx, cy);
                    ctx.lineTo(cx + radius * Math.cos(angle), cy + radius * Math.sin(angle));
                    ctx.stroke();
                }

                ctx.beginPath();
                for (var i = 0; i < n; i++) {
                    var angle = (Math.PI * 2 / n) * i - Math.PI / 2;
                    var ratio = Math.min(values[i], maxVal) / maxVal;
                    i === 0
                        ? ctx.moveTo(cx + radius * ratio * Math.cos(angle), cy + radius * ratio * Math.sin(angle))
                        : ctx.lineTo(cx + radius * ratio * Math.cos(angle), cy + radius * ratio * Math.sin(angle));
                }
                ctx.closePath();
                ctx.fillStyle   = hexToRgba(color, 0.4);
                ctx.strokeStyle = color;
                ctx.lineWidth   = 2;
                ctx.fill();
                ctx.stroke();

                for (var i = 0; i < n; i++) {
                    var angle = (Math.PI * 2 / n) * i - Math.PI / 2;
                    var ratio = Math.min(values[i], maxVal) / maxVal;
                    ctx.beginPath();
                    ctx.arc(
                        cx + radius * ratio * Math.cos(angle),
                        cy + radius * ratio * Math.sin(angle),
                        3, 0, Math.PI * 2
                    );
                    ctx.fillStyle = color;
                    ctx.fill();
                }

                ctx.font = 'bold 12px monospace';
                ctx.textBaseline = 'middle';
                var labelRadius = radius + 14;
                for (var i = 0; i < n; i++) {
                    var angle = (Math.PI * 2 / n) * i - Math.PI / 2;
                    var lx = cx + labelRadius * Math.cos(angle);
                    var ly = cy + labelRadius * Math.sin(angle);
                    ctx.textAlign = lx < cx - 5 ? 'right' : lx > cx + 5 ? 'left' : 'center';
                    ctx.fillStyle = '#fff';
                    ctx.fillText(labels[i], lx, ly);
                }
            }

            function agregarFavorito(btn) {
                var pokemonId = btn.getAttribute('data-id');
                var idUsuario = document.getElementById('idUsuarioLogueado').value;

                fetch('/favorito/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        usuario: { idUsuario: parseInt(idUsuario) },
                        pokemon: parseInt(pokemonId)
                    })
                })
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (data.Correct) {
                        Swal.fire({
                            icon: 'success', title: '¡Agregado!', text: data.Object,
                            confirmButtonColor: '#3085d6', confirmButtonText: 'Aceptar'
                        }).then(function() { location.reload(); });
                    } else {
                        Swal.fire({ icon: 'error', title: 'Error', text: data.Object });
                    }
                })
                .catch(function() {
                    Swal.fire({ icon: 'error', title: 'Error de conexión', text: 'No se pudo conectar con el servidor' });
                });
            }

            function removeFilter(param) {
                var url = new URL(window.location.href);
                url.searchParams.delete(param);
                window.location.href = url.toString();
            }
        </script>

    </body>
</html>
