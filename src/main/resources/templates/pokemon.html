<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <title>Información del Pokémon</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.min.css">

        <style>
            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }

            body {
                font-family: 'Press Start 2P', monospace;
                background-color: #1b1b2f;
                background-image:
                    linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
                    linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
                background-size: 40px 40px;
                min-height: 100vh;
                padding-top: 100px; /* Espacio para el navbar fijo */
                padding-bottom: 30px;
                color: #fff;
            }


            .navbar-retro {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 15px 25px;
                background: rgba(0, 0, 0, 0.85);
                backdrop-filter: blur(5px);
                border-bottom: 3px solid #333;
                z-index: 2000;
            }


            .back-btn {
                background: transparent;
                border: 2px solid #fff;
                color: #fff;
                padding: 10px 14px;
                font-size: 0.65rem;
                border-radius: 8px;
                cursor: pointer;
                font-family: 'Press Start 2P', monospace;
                letter-spacing: 1px;
                text-decoration: none;
                transition: all 0.3s ease;
                box-shadow: 0 0 8px rgba(255,255,255,0.2);
                white-space: nowrap;
            }

            .back-btn:hover {
                background: #fff;
                color: #000;
                box-shadow: 0 0 16px rgba(255,255,255,0.6);
                transform: translateY(-2px);
            }


            .logout-btn {
                background: rgba(0,0,0,0.8);
                border: 2px solid #dc3545;
                color: #dc3545;
                padding: 10px 16px;
                font-size: 0.7rem;
                border-radius: 8px;
                cursor: pointer;
                font-family: 'Press Start 2P', monospace;
                box-shadow: 0 0 10px rgba(220,53,69,0.3);
                transition: 0.3s;
            }

            .logout-btn:hover {
                background: #dc3545;
                color: white;
                box-shadow: 0 0 15px rgba(220,53,69,0.5);
            }
        </style>
    </head>

    <body>

        <nav class="navbar-retro">
            <div class="back-btn" id="backBtn" title="Atrás">
                ← ATRAS
            </div>

            <div>
                <a sec:authorize="hasRole('Usuario')" th:href="@{/pokemon/favoritos}" 
                   id="favBtn" 
                   class="btn btn-outline-warning btn-sm d-flex align-items-center gap-2" 
                   style="font-family: 'Press Start 2P', monospace; font-size: 0.65rem; padding: 8px 12px; border-width: 2px; text-decoration: none;">
                    <i class="bi bi-heart-fill"></i> 
                    <span class="d-none d-sm-inline">FAVORITOS</span>
                </a>
            </div>

            <form th:action="@{/logout}" method="post" style="margin: 0;">
                <button type="submit" class="logout-btn">
                    SALIR <i class="bi bi-box-arrow-right"></i>
                </button>
            </form>
        </nav>

        <div class="container">
            <div class="row justify-content-center">
                <div class="col-12 col-md-8 col-lg-5">
                    <div class="card shadow border-0 overflow-hidden" style="border-radius: 1.5rem;">

                        <div class="card-header text-white text-center py-4" th:style="'background: ' + ${Color}">
                            <div class="d-flex justify-content-between px-3 text-white-50 small fw-bold">
                                <a href="http://localhost:8080/pokemon" style="color: white; text-decoration: none;">POKÉDEX</a>
                                <span th:text="'#' + ${pokemon.id}">#25</span>
                            </div>
                            <h2 class="text-white text-capitalize mb-0 mt-2 display-6 fw-bold" th:text="${pokemon.name}">Nombre</h2>
                        </div>

                        <div class="card-body bg-white text-center pt-0">

                            <div class="bg-white rounded-circle d-inline-block shadow-sm p-3" 
                                 style="margin-top: -10px; width: 150px; height: 150px; border: 5px solid black;">
                                <img id="pokemonImg" 
                                     th:src="${pokemon.sprites.frontDefault}" 
                                     class="img-fluid" 
                                     style="cursor: pointer; transform: scale(1.2);"
                                     onclick="cambiarSprite()" alt="pokemon"
                                 onerror="this.onerror=null; this.src='https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/0.png';">
                            </div>

                            <div class="d-flex justify-content-center gap-4 my-3">
                                <i id="iconoShiny" class="bi bi-stars" onclick="toggleShiny()" style="cursor:pointer; font-size: 1.5rem; color: #333;" title="Modo Shiny"></i>
                                <i id="iconoGenero" class="bi bi-gender-male fs-3" onclick="toggleGenero()" style="cursor:pointer; color: #0d6efd;" title="Género"></i>
                                <i id="iconoSonido" class="bi bi-volume-up-fill fs-3 text-secondary" onclick="Sonido()" style="cursor:pointer;" title="Sonido"></i>
                            </div>

                            <div class="mb-4">
                                <span th:each="type, iterStat : ${pokemon.types}"
                                      th:text="${type.type.name}"
                                      th:style="'background-color: ' + ${coloresTipos[iterStat.index]}"
                                      class="badge rounded-pill text-white px-3 py-2 text-capitalize mx-1 shadow-sm">
                                </span>
                            </div>

                            <div class="row g-0 py-2 bg-light rounded-4 mb-4">
                                <div class="col-4 border-end">
                                    <small class="text-muted d-block" style="font-size: 0.5rem;">Peso</small>
                                    <span class="fw-bold text-dark" style="font-size: 0.7rem;" th:text="${pokemon.weight / 10.0} + ' kg'">6 kg</span>
                                </div>
                                <div class="col-4 border-end">
                                    <small class="text-muted d-block" style="font-size: 0.5rem;">Altura</small>
                                    <span class="fw-bold text-dark" style="font-size: 0.7rem;" th:text="${pokemon.height / 10.0} + ' m'">0.4 m</span>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted d-block" style="font-size: 0.5rem;">Base Exp</small>
                                    <span class="fw-bold text-dark" style="font-size: 0.7rem;" th:text="${pokemon.baseExperience}">112</span>
                                </div>
                            </div>

                            <div class="text-start mb-4 px-2">
                                <h6 class="fw-bold text-secondary mb-3" style="font-size: 0.6rem;"><i class="bi bi-bar-chart-fill"></i> ESTADÍSTICAS</h6>
                                <div th:each="stat : ${pokemon.stats}" class="row align-items-center mb-2">
                                    <div class="col-4 text-capitalize text-muted" style="font-size: 0.5rem;" th:text="${stat.stat.name}">hp</div>
                                    <div class="col-6 p-0">
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar rounded-pill" 
                                                 th:style="'width: ' + (${stat.baseStat} * 100 / 200) + '%; background-color: ' + ${Color}"
                                                 th:aria-valuenow="${stat.baseStat}" aria-valuemin="0" aria-valuemax="255"></div>
                                        </div>
                                    </div>
                                    <div class="col-2 text-end text-dark" style="font-size: 0.5rem;" th:text="${stat.baseStat}">50</div>
                                </div>
                            </div>

                            <div class="row text-start g-3 px-2 pb-3">
                                <div class="col-6">
                                    <h6 class="fw-bold text-secondary text-uppercase" style="font-size: 0.5rem;">Habilidades</h6>
                                    <div class="d-flex flex-wrap gap-1">
                                        <span th:each="ability : ${pokemon.abilities}" 
                                              th:text="${ability.ability.name}"
                                              class="badge bg-light text-dark border fw-normal text-capitalize w-100 py-2" style="font-size: 0.5rem;">
                                        </span>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <h6 class="fw-bold text-secondary text-uppercase" style="font-size: 0.5rem;">Movimientos</h6>
                                    <div class="overflow-auto border rounded-3 p-2 bg-light" style="max-height: 80px;">
                                        <span th:each="move : ${pokemon.moves}" 
                                              th:text="${move.move.name}"
                                              class="d-block text-dark text-capitalize mb-1 border-bottom pb-1" style="font-size: 0.45rem;">
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div> 
                    </div> 
                </div> 
            </div> 
        </div>

        <script th:inline="javascript">
            // [Tus funciones de audio, sprites, shiny y genero se mantienen igual]
            const audio = /*[[${pokemon.cries.latest}]]*/ ''
            const pokemonAudio = new Audio(audio);
            function Sonido() {
                pokemonAudio.currentTime = 0;
                pokemonAudio.play().catch(error => console.error("Error audio:", error));
            }

            const sprites = {
                front: /*[[${pokemon.sprites.frontDefault}]]*/ '',
                back: /*[[${pokemon.sprites.backDefault}]]*/ '',
                frontShiny: /*[[${pokemon.sprites.frontShiny}]]*/ '',
                backShiny: /*[[${pokemon.sprites.backShiny}]]*/ '',
                frontFem: /*[[${pokemon.sprites.frontFemale}]]*/ '',
                backFem: /*[[${pokemon.sprites.backFemale}]]*/ '',
                frontShinyFem: /*[[${pokemon.sprites.frontShinyFemale}]]*/ '',
                backShinyFem: /*[[${pokemon.sprites.backShinyFemale}]]*/ ''
            };

            let esShiny = false;
            let mostrandoFront = true;
            let esFemenino = false;

            function checkGeneroHabilitado() {
                const iconoG = document.getElementById('iconoGenero');
                if (!sprites.frontFem)
                    iconoG.style.display = 'none';
            }

            function actualizarImagen() {
                const img = document.getElementById('pokemonImg');
                let seleccionada = '';
                if (esFemenino && sprites.frontFem) {
                    if (esShiny && sprites.frontShinyFem)
                        seleccionada = mostrandoFront ? sprites.frontShinyFem : (sprites.backShinyFem || sprites.frontShinyFem);
                    else
                        seleccionada = mostrandoFront ? sprites.frontFem : (sprites.backFem || sprites.frontFem);
                } else {
                    if (esShiny)
                        seleccionada = mostrandoFront ? sprites.frontShiny : (sprites.backShiny || sprites.frontShiny);
                    else
                        seleccionada = mostrandoFront ? sprites.front : (sprites.back || sprites.front);
                }
                if (seleccionada)
                    img.src = seleccionada;
            }

            function cambiarSprite() {
                mostrandoFront = !mostrandoFront;
                actualizarImagen();
            }

            function toggleShiny() {
                if (esShiny || sprites.frontShiny) {
                    esShiny = !esShiny;
                    actualizarImagen();
                    document.getElementById('iconoShiny').style.color = esShiny ? '#f1c40f' : '#333';
                }
            }

            function toggleGenero() {
                if (sprites.frontFem) {
                    esFemenino = !esFemenino;
                    actualizarImagen();
                    const icono = document.getElementById('iconoGenero');
                    if (esFemenino) {
                        icono.className = 'bi bi-gender-female';
                        icono.style.color = '#e84393';
                    } else {
                        icono.className = 'bi bi-gender-male';
                        icono.style.color = '#3498db';
                    }
                }
            }

            checkGeneroHabilitado();

            document.getElementById('backBtn').addEventListener('click', function () {
                if (window.history.length > 1)
                    window.history.back();
                else
                    window.location.href = '/';
            });
        </script>
    </body>
</html>